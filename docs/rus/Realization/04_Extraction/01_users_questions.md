# Вопросы: 4.1 Users

Примечание (simplified model): Расширенная статусная машина и многошаговые RETRY политики заменены унифицированной моделью single-pass (NEW -> IMPORT_OK/IMPORT_ERR/ERROR_RETRY, maxRetries=3). Ниже сохранены финальные решения для исторической трассируемости.

| ID | Категория | Вопрос | Статус | Решение |
|----|-----------|--------|--------|---------|
| UQ1 | Поля | Нужны ли department / position? | closed | A: Переносим как есть (пустые не заполняем). |
Nie wiem, musi byc tak w Cloude bylo
|  |  | Пример: Если department пуст у 40% пользователей — переносим пустым или заполняем значением "General"? | note |  |
| UQ2 | Безопасность | Маскировать email (GDPR)? | closed | B: Полный email в данных; в логах/метриках masked. |
Nie wiem, musi byc po prostu w On-premise tak jak w Cloude
|  |  | Пример: Маскировка вида u***@domain — требуется или точное сохранение? | note |  |
| UQ3 | Повтор | SLA по RETRY (часы?) | closed | A: (Заменено) Теперь: максимум 3 попытки (0s,2s,6s). |
Nie rozumiem czego dotyczy etc 
|  |  | Пример: Ошибка импорта пользователя (email conflict) — повторяем через 1h, затем 3h, затем ручной разбор? | note |  |
| UQ4 | Политика | Переносить уволенных (inactive)? | closed | A: Импортируем всех; ставим STATUS=INACTIVE (или Active=false). |
Tak
|  |  | Пример: Inactive пользователи получают Status=DISABLED в on-prem или сохраняем активность идентичной? | note |  |
| UQ5 | Политика | Хранить ли аватары пользователей? | closed | B (только оригинал). |
Jesli sa w Cloude, to przenosic tez
|  |  | Пример: Аватар 1MB JPEG — сохраняем оригинал + thumbnail или только оригинал? | note |  |

## Решения и последствия
UQ1: Минимальная сложность, точная историчность; отчёт по пустым полям при необходимости очистки.
UQ2: Требует внедрить слой логирования, который заменяет локальную часть email (u***@domain); хранение в таблицах без изменений -> простая верификация уникальности.
UQ3: Изначальная многоступенчатая схема заменена простой (3 попытки), упрощая код и логику наблюдаемости.
UQ4: Гарантируется целостность ссылок (автор поста, ответственный задачи). UI должен фильтровать inactive.
UQ5: Подход A даёт полное визуальное соответствие. Ниже детали пайплайна обработки аватаров.

### UQ5: Пайплайн обработки аватаров ("обработчики")
Компоненты:
1. Загрузка (Download Handler): получение файла по URL (webhook auth), ограничение размера (например <=5MB), подсчёт SHA256 (для дедупликации).
2. Валидация (Validation Handler): проверка MIME (image/jpeg|png|gif), минимальных/максимальных размеров (ширина/высота), отказ для исполняемых форматов.
3. Ресайз (Resize/Thumbnail Handler): создание стандартного thumbnail (например 96x96 центр-кроп + 32x32), библиотека: Sharp (Node.js) или ImageMagick. Обработка в памяти ≤10MB.
4. Запись (Storage Handler):
	- Оригинал: blob path users/avatars/original/<userId>/<hash>.<ext>
	- Thumbnail: users/avatars/thumb/<userId>/<hash>_96.<ext>
	Метаданные: { userId, originalBlob, thumbBlob, hash, width, height, createdUtc } в таблице UserAvatarMeta.
5. Обновление профиля (Profile Update Handler): установка ссылок (public/secured SAS URL) в нормализованной записи пользователя перед импортом.
6. Ошибки (Error Handler): классификация (network, format, oversize) -> метрики avatar.download_err, avatar.resize_err; при сбое можно:
	- fallback: пометить AvatarStatus=SKIP и продолжить импорт пользователя.
7. Логирование / метрики: avatar.processed, avatar.dedup_hit (если hash уже есть), avatar.bytes_total.

Разница вариантов:
*Вариант A (оригинал + thumbnail)*: требуется шаги 1–7. Клиентский UI получает быстрые миниатюры, снижая трафик. Первичная сложность выше (ресайз + метаданные + дедупликация).
*Вариант B (только оригинал)*: реализуются шаги 1,2,4 (только оригинал),5,6. Нет thumbnail — UI или on-prem генерирует по требованию (большее время первой загрузки). Код короче (~‑30–40%).

Сложность реализации (оценочно):
- B: 0.5–1 день (download + validation + storage + ссылки + метрики базовые).
- A: +0.5–1 день (интеграция Sharp, тест форматов, дедупликация по hash, дополнительные метрики).

Оптимизации позже:
- Кэширование SHA256 -> skip повторных скачиваний если тот же hash уже привязан к другому пользователю.
- Асинхронный ресайз (пометка AvatarStatus=PENDING_THUMB, обновление ссылки позже) если время критично.

Fallback стратегия: если ресайз падает (неподдерживаемый формат, OOM) — сохраняем оригинал и помечаем ThumbnailStatus=SKIP, не блокируя импорт пользователя.

History:
- scaffold
- decisions applied (UQ1=A,UQ2=B,UQ3=A,UQ4=A,UQ5=B)
- simplified-note (статусы и retry обновлены)
