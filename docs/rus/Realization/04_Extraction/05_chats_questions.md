# Вопросы: 4.5 Chats

Примечание (simplified model): Убрана дельта после freeze — только первичный snapshot. Решение по CQ5 скорректировано.

| ID | Категория | Вопрос | Статус | Решение |
|----|-----------|--------|--------|---------|
| CQ1 | Scope | Нужны ли приватные 1:1 чаты полностью? | closed | A: Полный перенос всех 1:1 (метаданные + участники + сообщения в выбранной глубине). |
| CQ2 | History | Ограничивать ли глубину истории (N сообщений)? | closed | A: Без ограничения – вытягиваем всю доступную историю (rate/timeout контролируем throttling'ом). |
| CQ3 | Files | Переносить ли вложения сообщений (если есть)? | closed | A: Да, загружаем вложения и пересвязываем URL (stream + кеш). |
| CQ4 | Reactions | Нужно ли переносить реакции на сообщения? | closed | C: Перенос агрегированных счётчиков реакций (без детального списка пользователей). |
| CQ5 | Delta | Нужна ли дельта сообщений после cutover? | closed | (Заменено) Нет дельты: только primary snapshot (single-pass). |
|  |  | Пример: test_limit=5 означает импорт только 5 чатов и их первых страниц сообщений для smoke. | note |  |

## Решения и последствия
CQ1 (A): Полное покрытие приватных 1:1 -> максимальная целостность контекста общения; минус: объём (storage, API calls). Метрика: chats.private.count, время на импорт.
CQ2 (A): Вся история -> аналитика и поиск полностью доступны; минус: длительный ран первого прогона, риск hitting API limits. Митигируем: paging size, backoff, сохранение offset (resume).
CQ3 (A): Вложения сохраняют ценность сообщений; минусы: скачивание большого бинарного объёма, потребность в временном диске/кеше и повторных попытках при 429/5xx. Метрики: chats.attach.bytes_total, fail_ratio.
CQ4 (C): Агрегированные реакции дают базовое представление о вовлечённости с меньшими затратами (не нужна миграция списка пользователей каждой реакции); минусы: невозможен точный аудит «кто проставил». Если потребуется расширение – отдельная итерация (расширяем схему). Метрика: chats.reactions.migrated, chats.reactions.skipped_detail.
CQ5: (Упрощено) Нет дельты → минимальный код и мониторинг; сообщения, появившиеся после freeze, не импортируются (зафиксировано). Метрики chats.delta.* удалены.

## Дополнительные заметки / Implementation outline
1. Порядок: список чатов (batched) → полная история (reverse chronological) с сохранением cursor; вложения stream'ом; реакции отдельным вызовом/агрегацией.
2. Resume: per-chat checkpoint (last_message_id_processed).
3. Rate limiting: общий token bucket для messages + attachments.
4. (Delta удалена в simplified model – single-pass snapshot.)
5. Тестовый прогон (test_limit): ограничить количество чатов и сообщений per chat_page_size.

History:
- scaffold
- decisions applied (CQ1=A,CQ2=A,CQ3=A,CQ4=C,CQ5=B)
- simplified-note (CQ5 updated, delta removed)
